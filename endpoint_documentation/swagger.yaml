definitions:
  models.AddPermissionVisibilityRequest:
    properties:
      group_name:
        type: string
      permission_name:
        type: string
    required:
    - group_name
    - permission_name
    type: object
  models.ChangePasswordRequest:
    properties:
      mfa_code:
        type: string
      new_password:
        minLength: 8
        type: string
      old_password:
        minLength: 8
        type: string
    required:
    - new_password
    - old_password
    type: object
  models.CreateGroupRequest:
    properties:
      definition:
        type: string
      name:
        type: string
    required:
    - definition
    - name
    type: object
  models.CreatePermissionRequest:
    properties:
      definition:
        type: string
      name:
        type: string
    required:
    - definition
    - name
    type: object
  models.CreateUserRequest:
    properties:
      email:
        type: string
      password:
        minLength: 8
        type: string
    required:
    - email
    - password
    type: object
  models.CreateUserResponse:
    properties:
      user_id:
        type: string
    type: object
  models.DisableMFARequest:
    properties:
      mfa_code:
        type: string
    required:
    - mfa_code
    type: object
  models.ErrorDetails:
    properties:
      message:
        type: string
    type: object
  models.ErrorResponse:
    properties:
      error:
        $ref: '#/definitions/models.ErrorDetails'
    type: object
  models.GroupResponse:
    properties:
      description:
        type: string
      key:
        type: string
      name:
        type: string
    type: object
  models.ListUsersResponse:
    properties:
      users:
        items:
          $ref: '#/definitions/models.UserResponse'
        type: array
    type: object
  models.LoginRequest:
    properties:
      email:
        type: string
      mfa_code:
        type: string
      password:
        minLength: 8
        type: string
    required:
    - email
    - password
    type: object
  models.LoginResponse:
    properties:
      session_id:
        type: string
    type: object
  models.MFAResponse:
    properties:
      qr_code_url:
        type: string
      secret:
        type: string
    type: object
  models.MFAVerifyRequest:
    properties:
      code:
        type: string
      email:
        description: Required only for unauthenticated requests
        type: string
    required:
    - code
    type: object
  models.PasswordResetRequest:
    properties:
      email:
        type: string
      mfa_code:
        type: string
      new_password:
        minLength: 8
        type: string
      otp:
        type: string
    required:
    - email
    - new_password
    - otp
    type: object
  models.PermissionResponse:
    properties:
      description:
        type: string
      key:
        type: string
      name:
        type: string
    type: object
  models.RemovePermissionVisibilityRequest:
    properties:
      group_name:
        type: string
      permission_name:
        type: string
    required:
    - group_name
    - permission_name
    type: object
  models.RequestOTPRequest:
    properties:
      email:
        type: string
    required:
    - email
    type: object
  models.RequestUpdateFields:
    properties:
      groups_add:
        items:
          type: string
        type: array
      groups_remove:
        items:
          type: string
        type: array
      permissions_add:
        items:
          type: string
        type: array
      permissions_remove:
        items:
          type: string
        type: array
    type: object
  models.RequestUpdateRequest:
    properties:
      updates:
        $ref: '#/definitions/models.RequestUpdateFields'
    required:
    - updates
    type: object
  models.RevokeSessionRequest:
    properties:
      mfa_code:
        type: string
      user_id:
        type: string
    required:
    - user_id
    type: object
  models.SuccessResponse:
    properties:
      data: {}
    type: object
  models.UpdateGroupRequest:
    properties:
      definition:
        type: string
    required:
    - definition
    type: object
  models.UpdatePermissionRequest:
    properties:
      definition:
        type: string
    required:
    - definition
    type: object
  models.UpdateUserRequest:
    properties:
      approve_update:
        type: boolean
      groups:
        additionalProperties:
          type: boolean
        type: object
      mfa_enforced:
        type: boolean
      permissions:
        additionalProperties:
          type: boolean
        type: object
      reject_update:
        type: boolean
      status:
        $ref: '#/definitions/models.UserStatus'
    type: object
  models.UserGroups:
    additionalProperties:
      type: boolean
    type: object
  models.UserPermissions:
    additionalProperties:
      type: boolean
    type: object
  models.UserResponse:
    properties:
      created_at:
        type: string
      email:
        type: string
      groups:
        $ref: '#/definitions/models.UserGroups'
      id:
        type: string
      is_admin:
        type: boolean
      is_superuser:
        type: boolean
      last_login:
        type: string
      mfa_enabled:
        type: boolean
      mfa_enforced:
        type: boolean
      pending_updates:
        $ref: '#/definitions/models.UserUpdateRequest'
      permissions:
        $ref: '#/definitions/models.UserPermissions'
      status:
        $ref: '#/definitions/models.UserStatus'
      updated_at:
        type: string
    type: object
  models.UserStatus:
    enum:
    - ok
    - locked by admin
    - locked by security
    - pending admin approval
    - admin approval rejected
    type: string
    x-enum-varnames:
    - UserStatusOk
    - UserStatusLockedByAdmin
    - UserStatusLockedBySecurity
    - UserStatusPendingApproval
    - UserStatusApprovalRejected
  models.UserUpdateFields:
    properties:
      groups_add:
        items:
          type: string
        type: array
      groups_remove:
        items:
          type: string
        type: array
      permissions_add:
        items:
          type: string
        type: array
      permissions_remove:
        items:
          type: string
        type: array
    type: object
  models.UserUpdateRequest:
    properties:
      fields:
        $ref: '#/definitions/models.UserUpdateFields'
      requested_at:
        type: string
    type: object
info:
  contact: {}
  description: Lightweight and secure authentication service
  title: garde
  version: "1.0"
paths:
  /admin/groups:
    post:
      consumes:
      - application/json
      description: Creates a new group in the SQLite database. Only superuser can
        perform this operation.
      parameters:
      - description: Group details
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.CreateGroupRequest'
      produces:
      - application/json
      responses:
        "201":
          description: Group created
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.GroupResponse'
              type: object
        "400":
          description: Invalid request format
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized - superuser access required
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "409":
          description: Group already exists
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Create a new group
      tags:
      - Superuser Routes
  /admin/groups/{group_name}:
    delete:
      description: Deletes a group from the SQLite database. This will cascade delete
        all visibility mappings. Only superuser can perform this operation.
      parameters:
      - description: Group name
        in: path
        name: group_name
        required: true
        type: string
      produces:
      - application/json
      responses:
        "200":
          description: Group deleted
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  type: object
              type: object
        "401":
          description: Unauthorized - superuser access required
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: Group not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Delete a group
      tags:
      - Superuser Routes
    put:
      consumes:
      - application/json
      description: Updates a group's definition. Only superuser can perform this operation.
      parameters:
      - description: Group name
        in: path
        name: group_name
        required: true
        type: string
      - description: Updated group definition
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.UpdateGroupRequest'
      produces:
      - application/json
      responses:
        "200":
          description: Group updated
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.GroupResponse'
              type: object
        "400":
          description: Invalid request format
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized - superuser access required
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: Group not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Update a group
      tags:
      - Superuser Routes
  /admin/groups/users:
    get:
      description: Returns all group-user mappings (which users belong to which groups).
        Only superuser can perform this operation.
      produces:
      - application/json
      responses:
        "200":
          description: Map of group names to user emails
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  additionalProperties:
                    items:
                      type: string
                    type: array
                  type: object
              type: object
        "401":
          description: Unauthorized - superuser access required
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Operation failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Get all group-user mappings
      tags:
      - Superuser Routes
  /admin/permissions:
    post:
      consumes:
      - application/json
      description: Creates a new permission in the SQLite database. Only superuser
        can perform this operation.
      parameters:
      - description: Permission details
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.CreatePermissionRequest'
      produces:
      - application/json
      responses:
        "201":
          description: Permission created
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.PermissionResponse'
              type: object
        "400":
          description: Invalid request format
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized - superuser access required
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "409":
          description: Permission already exists
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Create a new permission
      tags:
      - Superuser Routes
  /admin/permissions/{permission_name}:
    delete:
      description: Deletes a permission from the SQLite database. This will cascade
        delete all visibility mappings. Only superuser can perform this operation.
      parameters:
      - description: Permission name
        in: path
        name: permission_name
        required: true
        type: string
      produces:
      - application/json
      responses:
        "200":
          description: Permission deleted
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  type: object
              type: object
        "401":
          description: Unauthorized - superuser access required
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: Permission not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Delete a permission
      tags:
      - Superuser Routes
    put:
      consumes:
      - application/json
      description: Updates a permission's definition. Only superuser can perform this
        operation.
      parameters:
      - description: Permission name
        in: path
        name: permission_name
        required: true
        type: string
      - description: Updated permission definition
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.UpdatePermissionRequest'
      produces:
      - application/json
      responses:
        "200":
          description: Permission updated
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.PermissionResponse'
              type: object
        "400":
          description: Invalid request format
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized - superuser access required
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: Permission not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Update a permission
      tags:
      - Superuser Routes
  /admin/permissions/visibility:
    delete:
      consumes:
      - application/json
      description: Removes a permission's visibility from a specific group. Only superuser
        can perform this operation.
      parameters:
      - description: Permission and group names
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.RemovePermissionVisibilityRequest'
      produces:
      - application/json
      responses:
        "200":
          description: Visibility mapping removed
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  type: object
              type: object
        "400":
          description: Invalid request format
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized - superuser access required
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: Permission, group, or visibility mapping not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Remove permission visibility from a group
      tags:
      - Superuser Routes
    get:
      description: Returns all permission visibility mappings (which groups can see
        which permissions). Only superuser can perform this operation.
      produces:
      - application/json
      responses:
        "200":
          description: Map of permission names to group names
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  additionalProperties:
                    items:
                      type: string
                    type: array
                  type: object
              type: object
        "401":
          description: Unauthorized - superuser access required
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Permissions system not loaded or operation failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Get all permission visibility mappings
      tags:
      - Superuser Routes
    post:
      consumes:
      - application/json
      description: Makes a permission visible to a specific group. Only superuser
        can perform this operation.
      parameters:
      - description: Permission and group names
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.AddPermissionVisibilityRequest'
      produces:
      - application/json
      responses:
        "201":
          description: Visibility mapping added
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  type: object
              type: object
        "400":
          description: Invalid request format
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized - superuser access required
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: Permission or group not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "409":
          description: Visibility mapping already exists
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Add permission visibility to a group
      tags:
      - Superuser Routes
  /admin/users/management:
    get:
      description: Returns which admins can manage which users (based on shared groups).
        Only superuser can perform this operation.
      produces:
      - application/json
      responses:
        "200":
          description: Map of admin emails to user emails they can manage
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  additionalProperties:
                    items:
                      type: string
                    type: array
                  type: object
              type: object
        "401":
          description: Unauthorized - superuser access required
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Operation failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Get admin-user management relationships
      tags:
      - Superuser Routes
  /groups:
    get:
      description: Returns all available groups defined in the system. Groups are
        managed via SQLite database.
      produces:
      - application/json
      responses:
        "200":
          description: List of groups
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  items:
                    $ref: '#/definitions/models.GroupResponse'
                  type: array
              type: object
      security:
      - SessionCookie: []
      - Bearer: []
      summary: List available groups
      tags:
      - Protected Routes
  /login:
    post:
      consumes:
      - application/json
      description: Authenticates a user and returns a session token. No mTLS required
        for this endpoint.
      parameters:
      - description: Login credentials
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.LoginRequest'
      produces:
      - application/json
      responses:
        "200":
          description: Returns session ID and sets session cookie
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.LoginResponse'
              type: object
        "400":
          description: Invalid request format
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Authentication failed, invalid credentials, MFA required, or
            invalid MFA code
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "429":
          description: Too many login attempts
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      summary: Login user
      tags:
      - Public Routes
  /logout:
    post:
      consumes:
      - application/json
      description: Invalidates the current session. No mTLS required for this endpoint.
      produces:
      - application/json
      responses:
        "200":
          description: Session invalidated successfully
          schema:
            $ref: '#/definitions/models.SuccessResponse'
        "400":
          description: No active session
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Internal server error
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Logout user
      tags:
      - Protected Routes
  /permissions:
    get:
      description: Returns available permissions. Regular users and admins only see
        permissions visible to their groups. Superusers see all permissions. Permissions
        are managed via SQLite database.
      produces:
      - application/json
      responses:
        "200":
          description: List of permissions
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  items:
                    $ref: '#/definitions/models.PermissionResponse'
                  type: array
              type: object
      security:
      - SessionCookie: []
      - Bearer: []
      summary: List available permissions
      tags:
      - Protected Routes
  /sessions/revoke:
    post:
      consumes:
      - application/json
      description: Revokes all active sessions for a user. Requires permissions/groups
        system to be initialized (SQLite-based).
      parameters:
      - description: Session revocation request with user ID
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.RevokeSessionRequest'
      produces:
      - application/json
      responses:
        "200":
          description: Sessions revoked successfully
          schema:
            $ref: '#/definitions/models.SuccessResponse'
        "400":
          description: Invalid request format
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "403":
          description: Forbidden - insufficient permissions
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Internal server error or permissions system not loaded
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Revoke user sessions
      tags:
      - Protected and Admin-Only Routes
  /users:
    get:
      consumes:
      - application/json
      description: 'Returns users with their details and pending requests. Admins
        see users in their groups, superusers see all. Permission visibility filtering:
        Regular users only see permissions visible to their groups in their own data.
        Admins see user''s permissions, but filtered to only show permissions visible
        to the admin''s groups. Superusers see all permissions for all users. Requires
        permissions/groups system to be initialized (SQLite-based).'
      produces:
      - application/json
      responses:
        "200":
          description: List of users
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.ListUsersResponse'
              type: object
        "401":
          description: Unauthorized
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "403":
          description: Forbidden - insufficient permissions
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Internal server error or permissions system not loaded
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: List users
      tags:
      - Protected and Admin-Only Routes
    post:
      consumes:
      - application/json
      description: Creates a new user account with pending approval status. No mTLS
        required for this endpoint.
      parameters:
      - description: User registration details
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.CreateUserRequest'
      produces:
      - application/json
      responses:
        "201":
          description: Returns created user ID
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.CreateUserResponse'
              type: object
        "400":
          description: Invalid request format, email format, password requirements
            not met, or email already exists
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: User creation failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      summary: Create new user
      tags:
      - Public Routes
  /users/{user_id}:
    delete:
      consumes:
      - application/json
      description: Deletes a user from the system. Admins can only delete users who
        share at least one group with them. Superuser can delete any user except themselves.
        All active sessions are revoked and security records are cleaned up. Requires
        permissions/groups system to be initialized (SQLite-based) for admin operations.
      parameters:
      - description: User ID
        in: path
        name: user_id
        required: true
        type: string
      produces:
      - application/json
      responses:
        "200":
          description: User deleted successfully
          schema:
            $ref: '#/definitions/models.SuccessResponse'
        "401":
          description: Unauthorized
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "403":
          description: Forbidden - insufficient permissions
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: User not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Internal server error or permissions system not loaded
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Delete user
      tags:
      - Protected and Admin-Only Routes
    get:
      consumes:
      - application/json
      description: Returns details for a specific user. Admins can only access users
        in their groups. Superuser can access all users. Requires permissions/groups
        system to be initialized (SQLite-based).
      parameters:
      - description: User ID
        in: path
        name: user_id
        required: true
        type: string
      produces:
      - application/json
      responses:
        "200":
          description: User information
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.UserResponse'
              type: object
        "401":
          description: Unauthorized
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "403":
          description: Forbidden - insufficient permissions
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: User not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Internal server error or permissions system not loaded
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Get user details
      tags:
      - Protected and Admin-Only Routes
    put:
      consumes:
      - application/json
      description: 'Update user details or process pending update requests. Requires
        admin privileges. Requires permissions/groups system to be initialized (SQLite-based).
        Approval restrictions: Admins can only approve adding groups they are members
        of. Admins can only approve adding permissions visible to their groups. If
        a pending update request includes groups the admin is not in, approval will
        fail with error. If a pending update request includes permissions the admin
        cannot see, approval will fail with error. Cannot approve requests that would
        remove all permissions or all groups. Admins can remove any groups (including
        the last shared group - this will revoke their access to manage that user).'
      parameters:
      - description: Target User ID to update
        in: path
        name: user_id
        required: true
        type: string
      - description: Update details including approve/reject flags for pending requests
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.UpdateUserRequest'
      produces:
      - application/json
      responses:
        "200":
          description: User updated successfully
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.UserResponse'
              type: object
        "400":
          description: Invalid request
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized or admin tried to approve adding groups they're
            not a member of
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "403":
          description: Forbidden - insufficient permissions
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: User not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "409":
          description: User update in progress or concurrent update detected
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Internal server error or permissions system not loaded
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Update user information
      tags:
      - Protected and Admin-Only Routes
  /users/me:
    get:
      consumes:
      - application/json
      description: Returns the authenticated user's information. Permissions are filtered
        by visibility - users (both regular users and admins) only see permissions
        visible to their groups. Superusers see all permissions. No mTLS required
        for this endpoint.
      produces:
      - application/json
      responses:
        "200":
          description: Current user information
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.UserResponse'
              type: object
        "401":
          description: Unauthorized or invalid session
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: User not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Get current user information
      tags:
      - Protected Routes
  /users/mfa/disable:
    post:
      consumes:
      - application/json
      description: Disables Multi-Factor Authentication for the authenticated user
        if not enforced. No mTLS required for this endpoint.
      parameters:
      - description: MFA verification code
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.DisableMFARequest'
      produces:
      - application/json
      responses:
        "200":
          description: MFA disabled successfully
          schema:
            $ref: '#/definitions/models.SuccessResponse'
        "400":
          description: Invalid MFA code or invalid request format
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized or MFA enforced by policy
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: User not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Operation failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Disable MFA
      tags:
      - Protected Routes
  /users/mfa/setup:
    post:
      consumes:
      - application/json
      description: Sets up Multi-Factor Authentication for a user. No mTLS required
        for this endpoint. Requires authentication.
      produces:
      - application/json
      responses:
        "200":
          description: Returns MFA secret and QR code URL
          schema:
            allOf:
            - $ref: '#/definitions/models.SuccessResponse'
            - properties:
                data:
                  $ref: '#/definitions/models.MFAResponse'
              type: object
        "400":
          description: MFA already enabled or setup failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized when using authenticated mode
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: User not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Operation failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Setup MFA
      tags:
      - Protected Routes
  /users/mfa/verify:
    post:
      consumes:
      - application/json
      description: Verifies MFA code and enables MFA for the user. No mTLS required
        for this endpoint. Requires authentication.
      parameters:
      - description: MFA verification code
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.MFAVerifyRequest'
      produces:
      - application/json
      responses:
        "200":
          description: MFA enabled successfully
          schema:
            $ref: '#/definitions/models.SuccessResponse'
        "400":
          description: Invalid MFA code, invalid request format, or MFA already enabled
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized when using authenticated mode
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: User not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Operation failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Verify and enable MFA
      tags:
      - Protected Routes
  /users/password/change:
    post:
      consumes:
      - application/json
      description: Changes the user's password. No mTLS required for this endpoint.
      parameters:
      - description: Change password request
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.ChangePasswordRequest'
      produces:
      - application/json
      responses:
        "200":
          description: Password changed successfully
          schema:
            $ref: '#/definitions/models.SuccessResponse'
        "400":
          description: Invalid request format, old password incorrect, or password
            requirements not met
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized or invalid session
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "403":
          description: MFA required or invalid MFA code
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: User not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Operation failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Change password
      tags:
      - Protected Routes
  /users/password/otp:
    post:
      consumes:
      - application/json
      description: Sends a one-time password to user's primary email. No mTLS required
        for this endpoint.
      parameters:
      - description: Request OTP
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.RequestOTPRequest'
      produces:
      - application/json
      responses:
        "200":
          description: OTP sent successfully (or no-op if email doesn't exist)
          schema:
            $ref: '#/definitions/models.SuccessResponse'
        "400":
          description: Invalid email format or request
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Operation failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      summary: Request OTP for password reset
      tags:
      - Public Routes
  /users/password/reset:
    post:
      consumes:
      - application/json
      description: Resets the user's password using OTP, and optionally MFA. No mTLS
        required for this endpoint.
      parameters:
      - description: Password reset request
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.PasswordResetRequest'
      produces:
      - application/json
      responses:
        "200":
          description: Password reset successful but pending admin approval
          schema:
            $ref: '#/definitions/models.SuccessResponse'
        "400":
          description: Invalid request format, invalid OTP, invalid MFA code, or password
            requirements not met
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "403":
          description: Unauthorized, too many unsuccessful attempts
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: User not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Operation failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      summary: Reset password
      tags:
      - Public Routes
  /users/request-update-from-admin:
    post:
      consumes:
      - application/json
      description: 'User requests changes from an admin to their permissions or groups.
        Uses explicit add/remove lists to clearly indicate what changes are being
        requested. Visibility restrictions: Users can only request permissions visible
        to at least one of their groups. If a user tries to request a permission not
        visible to their groups, the request will fail. Users can only remove permissions
        they currently have. No mTLS required for this endpoint. Request format: permissions_add
        (array of permission names to add), permissions_remove (array of permission
        names to remove), groups_add (array of group names to add), groups_remove
        (array of group names to remove). At least one of these arrays must be non-empty.'
      parameters:
      - description: Update request with permissions_add, permissions_remove, groups_add,
          groups_remove arrays
        in: body
        name: request
        required: true
        schema:
          $ref: '#/definitions/models.RequestUpdateRequest'
      produces:
      - application/json
      responses:
        "200":
          description: Update request submitted successfully
          schema:
            $ref: '#/definitions/models.SuccessResponse'
        "400":
          description: Invalid request format or empty update request
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized or invalid session
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "404":
          description: User not found
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Operation failed
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - Bearer: []
      summary: Request update for user information
      tags:
      - Protected Routes
  /validate:
    get:
      consumes:
      - application/json
      description: Validates a session token. Require API key + mTLS. No other type
        of authentication is supported
      parameters:
      - description: Session ID (required only for API requests with API key)
        in: query
        name: session_id
        type: string
      produces:
      - application/json
      responses:
        "200":
          description: Session validation result with Response.valid and UserID fields
          schema:
            $ref: '#/definitions/models.SuccessResponse'
        "400":
          description: Invalid session ID format or missing session ID for API request
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "401":
          description: Unauthorized - invalid session, missing mTLS certificate for
            API requests, or invalid API key
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "403":
          description: Forbidden - insufficient permissions (user not in admin's groups)
          schema:
            $ref: '#/definitions/models.ErrorResponse'
        "500":
          description: Internal server error or permissions system not loaded
          schema:
            $ref: '#/definitions/models.ErrorResponse'
      security:
      - SessionCookie: []
      - ApiKey: []
      - Bearer: []
      summary: Validate a session
      tags:
      - For Internal Services
securityDefinitions:
  ApiKey:
    in: header
    name: X-API-Key
    type: apiKey
  Bearer:
    in: header
    name: Authorization
    type: apiKey
  SessionCookie:
    in: header
    name: Authorization
    type: apiKey
swagger: "2.0"
