services:

  # DEV: Vault Server (dev mode)
  dev-vault:
    image: hashicorp/vault:1.15
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: devtoken
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    ports:
      - "8200:8200"
    networks:
      - vault_network
    healthcheck:
      test: ["CMD", "sh", "-c", "VAULT_ADDR=http://127.0.0.1:8200 vault status"]
      interval: 5s
      timeout: 3s
      retries: 10
    profiles:
      - dev

  # DEV: Vault Init (seeds secrets from dev.secrets)
  dev-vault-init:
    image: hashicorp/vault:1.15
    entrypoint: /bin/sh
    command: /vault/init-vault.sh
    environment:
      VAULT_ADDR: http://dev-vault:8200
      VAULT_TOKEN: devtoken
    volumes:
      - ./vault/init-vault.sh:/vault/init-vault.sh:ro
      - ./dev.secrets:/dev.secrets:ro
    depends_on:
      dev-vault:
        condition: service_healthy
    networks:
      - vault_network
    profiles:
      - dev

  # DEV: Vault Agent (writes secrets to tmpfs)
  dev-vault-agent:
    image: hashicorp/vault:1.15
    command: vault agent -config=/vault/config/agent.hcl
    environment:
      VAULT_ADDR: http://dev-vault:8200
    volumes:
      - ./vault/agent-config-dev.hcl:/vault/config/agent.hcl:ro
      - ./vault/dev-token:/vault/config/dev-token:ro
      - vault-secrets:/run/secrets
    depends_on:
      dev-vault-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "sh", "-c", "test -s /run/secrets/redis_host"]
      interval: 2s
      timeout: 2s
      retries: 30
    networks:
      - vault_network
    profiles:
      - dev

  # DEV: Redis
  dev-redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass "redis"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - redis_network
    profiles:
      - dev

  # DEV: Auth Service (with bundled Vault + Redis)
  dev-garde:
    build:
      context: .
      dockerfile: Dockerfile
      target: service
    ports:
      - "8443:8443"
    volumes:
      - ./certs:/app/certs:ro
      - ./configs:/app/configs:ro
      - ./data:/app/data
      - vault-secrets:/run/secrets:ro
    environment:
      DOCKER_PROFILE: with-redis
    depends_on:
      dev-vault-agent:
        condition: service_healthy
      dev-redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - auth_network
      - redis_network
      - vault_network
    profiles:
      - dev

volumes:
  redis_data:
    driver: local
  vault-secrets:
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=1m,mode=0777

networks:
  auth_network:
    name: garde_network
    driver: bridge
  redis_network:
    name: redis_service_network
    driver: bridge
  vault_network:
    name: vault_network
    driver: bridge
